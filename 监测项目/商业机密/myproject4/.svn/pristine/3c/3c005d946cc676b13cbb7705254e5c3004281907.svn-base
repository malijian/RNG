<template>
  <div class="m-complete-handle">
    <el-form ref="alreadyFormRef" class="alreadyForm" :model="alreadyForm" label-width="152px">
      <div v-if="branckUserAlready === 'branch'">
        <template>
          <el-row>
            <!-- <el-col :span="6">
              <el-form-item label="联合分析流程">
                <template>
                  <span>(共计：{{alreadyForm.jointAnalysis}})</span>
                </template>
              </el-form-item>
            </el-col>
            <el-col :span="6">
                <el-form-item label="行政调查管理">
                  <template>
                    <span>(共计：{{alreadyForm.adm}})</span>
                  </template>
                </el-form-item>
            </el-col> -->
            <el-col :span="6">
                <el-form-item label="上报分析申请">
                  <template>
                    <span>(共计：{{alreadyForm.reportLeads}})</span>
                  </template>
                </el-form-item>
            </el-col>
            <el-col :span="6">
                <el-form-item label="跨区域数据申请">
                  <template>
                    <span>(共计：{{alreadyForm.specialApply}})</span>
                  </template>
                </el-form-item>
            </el-col>
          </el-row>
        </template>
      </div>
      <div v-if="branckUserAlready !== 'branch'">
        <template v-if="togglealreadySearch">
          <el-row>
            <el-col :span="5">
              <el-form-item label="排名规则预警" >
                <template>
                  <span>(共计：{{alreadyForm.rankingRules}})</span>
                </template>
              </el-form-item>
            </el-col>
            <el-col :span="5">
              <el-form-item label="模型预警">
                <template>
                  <span>(共计：{{alreadyForm.modelQuery}})</span>
                </template>
              </el-form-item>
            </el-col>
            <el-col :span="5">
              <el-form-item label="高级名单预警">
                <template>
                  <span>(共计：{{alreadyForm.seniorListWarnQuery}})</span>
                </template>
              </el-form-item>
            </el-col>
            <el-col :span="4">
              <el-button type="text" style="padding: 7px" icon="el-icon-arrow-down" @click="togglealreadySearch=false">展开</el-button>
            </el-col>
          </el-row>
        </template>
        <template v-else>
            <el-row>
              <el-col :span="6">
                <el-form-item label="排名规则预警" >
                  <template>
                    <span>(共计：{{alreadyForm.rankingRules}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="模型预警">
                  <template>
                    <span>(共计：{{alreadyForm.modelQuery}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="高级名单预警">
                  <template>
                    <span>(共计：{{alreadyForm.seniorListWarnQuery}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="高级名单预警任务审批">
                  <template>
                    <span>(共计：{{alreadyForm.seniorListWarnJob}})</span>
                  </template>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="数据录入">
                    <template>
                      <span>(共计：{{alreadyForm.inputafter}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="自主分析流程">
                  <template>
                    <span>(共计：{{alreadyForm.InAnalysis}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="境内协查类文件流程">
                  <template>
                    <span>(共计：{{alreadyForm.AnalysisFile}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="境内情报类文件流程">
                  <template>
                    <span>(共计：{{alreadyForm.IntelliFile}})</span>
                  </template>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="名单预警任务审批">
                    <template>
                      <span>(共计：{{alreadyForm.listWarnJob}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="国际协查报行领导">
                  <template>
                    <span>(共计：{{alreadyForm.interHangQingbao}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="国际协查报中心领导" >
                  <template>
                    <span>(共计：{{alreadyForm.gjzhongxin}})</span>
                  </template>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="联合分析流程">
                  <template>
                    <span>(共计：{{alreadyForm.jointAnalysis}})</span>
                  </template>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="行政调查管理">
                    <template>
                      <span>(共计：{{alreadyForm.adm}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="宏观分析报告审批">
                    <template>
                      <span>(共计：{{alreadyForm.mpReportManagement}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="上报分析申请">
                    <template>
                      <span>(共计：{{alreadyForm.reportLeads}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="规则删除">
                    <template>
                      <span>(共计：{{alreadyForm.ruleDeletion}})</span>
                    </template>
                  </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="国际协查提请">
                    <template>
                      <span>(共计：{{alreadyForm.interXiecha}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="数据清理审批">
                    <template>
                      <span>(共计：{{alreadyForm.planApproval}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="信息补充通知审批">
                    <template>
                      <span>(共计：{{alreadyForm.supplyCorrect}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="举报处理">
                    <template>
                      <span>(共计：{{alreadyForm.fillReport}})</span>
                    </template>
                  </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="敏感人物审批">
                    <template>
                      <span>(共计：{{alreadyForm.sensitivePersons}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="跨区域数据申请">
                    <template>
                      <span>(共计：{{alreadyForm.specialApply}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="规则禁用">
                    <template>
                      <span>(共计：{{alreadyForm.ruleDisable}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="规则启动">
                    <template>
                      <span>(共计：{{alreadyForm.ruleStart}})</span>
                    </template>
                  </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="规则添加">
                    <template>
                      <span>(共计：{{alreadyForm.ruleAdd}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="定点监测审批">
                    <template>
                      <span>(共计：{{alreadyForm.point}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="大额信息补正">
                    <template>
                      <span>(共计：{{alreadyForm.correctApproval}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="可疑信息更正">
                    <template>
                      <span>(共计：{{alreadyForm.suspectCorrect}})</span>
                    </template>
                  </el-form-item>
              </el-col>
            </el-row>
            <el-row>
              <el-col :span="6">
                  <el-form-item label="数据迁移">
                    <template>
                      <span>(共计：{{alreadyForm.dataLifeCycleManage}})</span>
                    </template>
                  </el-form-item>
              </el-col>
              <el-col :span="6">
                  <el-form-item label="可疑交易报告预警">
                    <template>
                      <span>(共计：{{alreadyForm.findByReportDispose}})</span>
                    </template>
                  </el-form-item>
              </el-col>
          </el-row>
          <div style="text-align:right; margin-bottom:10px">
            <el-button type="text" icon="el-icon-arrow-up" @click="togglealreadySearch=true">收起</el-button>
          </div>
        </template>

      </div>
    </el-form>
    <el-row>
      <el-col :span="24" style="text-align: right;">
        <el-form :model="form" inline>
          <el-form-item label="标题：" label-width="60px">
            <el-input v-model="form.title"></el-input>
          </el-form-item>
          <el-form-item label="接收日期：" label-width="100px">
            <el-date-picker value-format="yyyy-MM-dd" v-model="form.date" type="daterange" range-separator="至" start-placeholder="开始日期" end-placeholder="结束日期">
            </el-date-picker>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="searchData">查 询</el-button>
            <el-button type="primary" plain @click="clearSearchData">清 空</el-button>
          </el-form-item>
        </el-form>
      </el-col>
    </el-row>

    <el-table style="width: 100%" :data="tableData" tooltip-effect="dark">
      <el-table-column type="index" label="序号" width="80"></el-table-column>
      <el-table-column prop="title" label="标题" min-width="200" show-overflow-tooltip>

      </el-table-column>
      <el-table-column prop="createtime" label="接收日期">
        <template slot-scope="scope">
          {{scope.row.createtime}} <!--| formatTime('{y}-{m}-{d} {h}:{m}:{s}')-->
        </template>
      </el-table-column>
      <!-- <el-table-column prop="creatorName" label="申请人"></el-table-column>
      <el-table-column prop="senderNames" label="发送人"></el-table-column> -->
      <el-table-column prop="workitemName" label="环节名称" show-overflow-tooltip></el-table-column>

      <el-table-column prop="option" label="操作" width="180">
        <template slot-scope="scope">
          <router-link :to="{name:'monitoringAnalysisWorkFlow',query:{
            proInstId: scope.row.proInstId,
            workitemId: scope.row.workitemId,
            workitemName: scope.row.workitemName,
            actInstId: scope.row.actInstId,
            actDefId: scope.row.actDefId,
            pkgId:scope.row.pkgId,
            readType:'doneAndFinished',
            roleType:'done'
          }}">
            <el-button type="text" @click="setSess">查看</el-button>
          </router-link>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination v-if="pageInfo.total" @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="pageInfo.pageNum" :page-size="pageInfo.pagesize" layout="total, sizes, prev, pager, next, jumper" :total="pageInfo.total" background>
    </el-pagination>
  </div>

</template>
<script>
import { operatPlatform, tallPlatform } from '@/api/sys-monitoringAnalysis/workFlow/index.js'
import { formatTime } from '@/utils'
import { mapGetters } from 'vuex'
export default {
  component() {
    formatTime
  },
  data() {
    return {
      form: {
        title: null,
        date: null,
        readType: 'doneAndFinished'
      },
      alreadyForm: {
        dataLifeCycleManage: '0',
        findByReportDispose: '0',
        rankingRules: '0',
        modelQuery: '0',
        seniorListWarnQuery: '0',
        seniorListWarnJob: '0',
        inputafter: '0',
        InAnalysis: '0',
        AnalysisFile: '0',
        IntelliFile: '0',
        listWarnJob: '0',
        interHangQingbao: '0',
        gjzhongxin: '0',
        jointAnalysis: '0',
        adm: '0',
        mpReportManagement: '0',
        reportLeads: '0',
        interXiecha: '0',
        supplyCorrect: '0',
        specialApply: '0',
        ruleDisable: '0',
        ruleStart: '0',
        ruleAdd: '0',
        point: '0',
        correctApproval: '0',
        suspectCorrect: '0',
        fillReport: '0',
        planApproval: '0',
        ruleDeletion: '0',
        sensitivePersons: '0'

        // interQingbao: '0',
        // receiver: '0',
        // interTongbao: '0',
        // interInvest: '0'
        // jointAnalysis: '0'
      },
      togglealreadySearch: true,
      tableData: [],
      pageInfo: {
        pageNum: 1,
        pageSize: 10,
        total: null
      },
      objInfo: {},
      branckUserAlready: ''
    }
  },
  filters: {
    formatTime(date, option) {
      return formatTime(date, option)
    }
  },
  computed: {
    ...mapGetters([
      //   'name',
      'roles'
    ]),
    paramsObj() {
      const obj = Object.assign({}, this.form, this.pageInfo)
      delete obj.date
      delete obj.total
      if (this.form.date) {
        obj.startTime = this.form.date[0]
        obj.endTime = this.form.date[1]
      } else {
        obj.startTime = ''
        obj.endTime = ''
      }
      return obj
    }
  },
  mounted() {
    this.branckUserAlready = this.roles
    if (sessionStorage.getItem('xtfDone') !== null) {
      this.getSeeion()
    } else {
      this.searchData()
    }
  },
  methods: {
    setSess() {
      // this.$emit('sendMsg', JSON.stringify([{
      //   title: this.form.title,
      //   date: this.form.date,
      //   pageNum: this.pageInfo.pageNum,
      //   pagesize: this.pageInfo.pagesize
      // }]))
      this.setSeeion()
    },
    getSeeion() {
      const xtfSessionChuLi = JSON.parse(sessionStorage.getItem('xtfDone'))
      this.form.title = xtfSessionChuLi[0].title
      this.form.date = xtfSessionChuLi[0].date
      this.pageInfo.pageNum = xtfSessionChuLi[0].pageNum
      this.pageInfo.pagesize = xtfSessionChuLi[0].pagesize
      this.searchDataSess()
      this.sessionStorageClear()
      // this.$$nextTick(() => {
      //   this.sessionStorageClear()
      // })
    },
    setSeeion() {
      const sess = [{
        title: this.form.title,
        date: this.form.date,
        pageNum: this.pageInfo.pageNum,
        pagesize: this.pageInfo.pagesize
      }]
      console.log(sess)
      sessionStorage.setItem('xtfDone', JSON.stringify(sess))
    },
    sessionStorageClear() {
      sessionStorage.removeItem('xtfDone')
    },
    searchDataSess() {
      // this.pageInfo.pageNum = 1
      this.objInfo.pageSize = this.pageInfo.pageSize
      this.objInfo.pageNum = this.pageInfo.pageNum
      this.objInfo.title = this.form.title ? this.form.title : ''
      this.objInfo.startTime = this.form.date ? this.form.date[0] : ''
      this.objInfo.endTime = this.form.date ? this.form.date[1] : ''
      this.objInfo.readType = 'doneAndFinished'
      this.fetchData()
    },
    searchData() {
      this.pageInfo.pageNum = 1
      this.objInfo.pageSize = this.pageInfo.pageSize
      this.objInfo.pageNum = this.pageInfo.pageNum
      this.objInfo.title = this.form.title ? this.form.title : ''
      this.objInfo.startTime = this.form.date ? this.form.date[0] : ''
      this.objInfo.endTime = this.form.date ? this.form.date[1] : ''
      this.objInfo.readType = 'doneAndFinished'
      this.fetchData()
    },
    // 重置
    clearSearchData() {
      this.form = {
        title: null,
        date: null,
        readType: 'doneAndFinished'
      }
      this.pageInfo.pageNum = 1
      this.pageInfo.pageSize = 10
      this.objInfo.pageNum = 1
      this.objInfo.pageSize = 10
      this.objInfo.title = ''
      this.objInfo.startTime = ''
      this.objInfo.endTime = ''
      this.objInfo.readType = 'doneAndFinished'
    },
    // 请求数据
    fetchData() {
      operatPlatform(this.objInfo).then(res => {
        if (res.code === 200) {
          this.tableData = res.data.list
          this.pageInfo.total = res.data.total
        }
      })
      tallPlatform(this.paramsObj).then(res => {
        if (res.code === 200) {
          this.alreadyForm.rankingRules = res.data.rankingRules ? res.data.rankingRules : '0'
          this.alreadyForm.modelQuery = res.data.modelQuery ? res.data.modelQuery : '0'
          this.alreadyForm.seniorListWarnQuery = res.data.seniorListWarnQuery ? res.data.seniorListWarnQuery : '0'
          this.alreadyForm.seniorListWarnJob = res.data.seniorListWarnJob ? res.data.seniorListWarnJob : '0'
          this.alreadyForm.inputafter = res.data.inputafter ? res.data.inputafter : '0'
          this.alreadyForm.InAnalysis = res.data.InAnalysis ? res.data.InAnalysis : '0'
          this.alreadyForm.AnalysisFile = res.data.AnalysisFile ? res.data.AnalysisFile : '0'
          this.alreadyForm.IntelliFile = res.data.IntelliFile ? res.data.IntelliFile : '0'
          this.alreadyForm.listWarnJob = res.data.listWarnJob ? res.data.listWarnJob : '0'
          this.alreadyForm.interHangQingbao = res.data.interHangQingbao ? res.data.interHangQingbao : '0'
          this.alreadyForm.gjzhongxin = res.data.gjzhongxin ? res.data.gjzhongxin : '0'
          // this.alreadyForm.jointAnalysis = res.data.jointAnalysis ? res.data.jointAnalysis : '0'
          this.alreadyForm.adm = res.data.adm ? res.data.adm : '0'
          this.alreadyForm.mpReportManagement = res.data.mpReportManagement ? res.data.mpReportManagement : '0'
          this.alreadyForm.reportLeads = res.data.reportLeads ? res.data.reportLeads : '0'
          // this.alreadyForm.interQingbao = res.data.interQingbao ? res.data.interQingbao : '0'
          this.alreadyForm.interXiecha = res.data.interXiecha ? res.data.interXiecha : '0'
          // this.alreadyForm.receiver = res.data.receiver ? res.data.receiver : '0'
          this.alreadyForm.supplyCorrect = res.data.supplyCorrect ? res.data.supplyCorrect : '0'
          // this.alreadyForm.interTongbao = res.data.interTongbao ? res.data.interTongbao : '0'
          // this.alreadyForm.interInvest = res.data.interInvest ? res.data.interInvest : '0'
          this.alreadyForm.specialApply = res.data.specialApply ? res.data.specialApply : '0'
          this.alreadyForm.ruleDisable = res.data.ruleDisable ? res.data.ruleDisable : '0'
          this.alreadyForm.ruleStart = res.data.ruleStart ? res.data.ruleStart : '0'
          this.alreadyForm.ruleAdd = res.data.ruleAdd ? res.data.ruleAdd : '0'
          this.alreadyForm.point = res.data.point ? res.data.point : '0'
          this.alreadyForm.correctApproval = res.data.correctApproval ? res.data.correctApproval : '0'
          this.alreadyForm.suspectCorrect = res.data.suspectCorrect ? res.data.suspectCorrect : '0'
          this.alreadyForm.fillReport = res.data.fillReport ? res.data.fillReport : '0'
          this.alreadyForm.jointAnalysis = res.data.jointAnalysis ? res.data.jointAnalysis : '0'
          this.alreadyForm.planApproval = res.data.planApproval ? res.data.planApproval : '0'
          this.alreadyForm.ruleDeletion = res.data.ruleDeletion ? res.data.ruleDeletion : '0'
          this.alreadyForm.sensitivePersons = res.data.sensitivePersons ? res.data.sensitivePersons : '0'
          this.alreadyForm.dataLifeCycleManage = res.data.dataLifeCycleManage ? res.data.dataLifeCycleManage : '0'
          this.alreadyForm.findByReportDispose = res.data.findByReportDispose ? res.data.findByReportDispose : '0'
        }
      })
    },
    // 切换分页条数
    handleSizeChange(size) {
      this.pageInfo.pageSize = size
      this.objInfo.pageSize = size
      this.fetchData(this.objInfo)
    },
    // 点击切换分页
    handleCurrentChange(pageNum) {
      this.pageInfo.pageNum = pageNum
      this.objInfo.pageNum = pageNum
      this.fetchData(this.objInfo)
    }
  }
}
</script>
<style lang="scss">
.m-complete-handle {
  .el-form--inline .el-form-item {
    margin-bottom: 8px;
    margin-right: 0px;
    margin-top: 15px;
  }
  .alreadyForm{
    .el-row{
      line-height: 12x;
      .el-col-6,.el-col-5{
        .el-form-item{
          margin-bottom: -8px;
        }
        .el-form-item label,.el-form-item span{
          font-size: 12px;
          color:#606266
        }
      }
    }
  }
}
</style>
