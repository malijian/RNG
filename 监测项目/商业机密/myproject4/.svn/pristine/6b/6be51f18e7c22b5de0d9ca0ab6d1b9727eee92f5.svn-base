<template>
  <div class="rankingRules">
    <el-card>
      <div slot="header">
        <span>排名规则预警处理</span>
      </div>

      <el-row>
        <el-col :span="7">
          <el-form :model="modelForm" label-width="100px" style="border-radius:4px;paddingTop:5px">
              <el-form-item label="规则名称：" prop="clientType">
                <el-popover trigger="hover" placement="top">
                  <p>{{ modelForm.clientType }}</p>
                  <div slot="reference" class="name-wrapper">
                    <el-tag size="small" style="width:90%;overflow:hidden;color:#606266;text-overflow:ellipsis;white-space: nowrap;">{{ modelForm.clientType }}</el-tag>
                  </div>
                </el-popover>
              </el-form-item>
            <el-form-item label="规则释义：" prop="ruleInterpretation">
              <el-popover trigger="hover" placement="top">
                  <p>{{ modelForm.ruleInterpretation }}</p>
                  <div slot="reference" class="name-wrapper">
                    <el-tag size="small" style="width:90%;overflow:hidden;color:#606266;text-overflow:ellipsis;white-space: nowrap;">{{ modelForm.ruleInterpretation }}</el-tag>
                  </div>
                </el-popover>
            </el-form-item>
            <el-form-item label="规则周期：" prop="warningCycle" >
              <el-popover trigger="hover" placement="top">
                  <p>{{this.mouthInfo}}</p>
                  <div slot="reference" class="name-wrapper">
                    <el-tag size="small" style="width:90%;overflow:hidden;color:#606266;text-overflow:ellipsis;white-space: nowrap;">{{this.mouthInfo}}</el-tag>
                  </div>
                </el-popover>
            </el-form-item>
          </el-form>
          <el-tree ref="tree" :data="tableDataTree" node-key="rulesId" class="treeClassName" @node-click="handleNodeClick" :props="defaultProps" highlight-current>
            <span class="span-ellipsis" slot-scope="{ node}">
              <span :title="node.label">{{ node.label }}</span>
            </span>
          </el-tree>
        </el-col>
        <el-col :span="17">
          <el-form :model="querymodelForm" :rules="rulesForm" ref="refForm" label-width="100px">
            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="预警结果日期：" prop="resultsDisplay">
                  <el-date-picker type="month" clearable v-model="querymodelForm.resultsDisplay" value-format="yyyy-MM" format="yyyy 年 MM 月" placeholder="日期选择"></el-date-picker>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="排序方式：" prop="sortord">
                  <el-radio v-model="querymodelForm.sortord" label="asc" style="margin-right:15px">升序</el-radio>
                  <el-radio v-model="querymodelForm.sortord" label="desc">降序</el-radio>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="显示记录数：" prop="">
                  <el-input-number v-model="querymodelForm.displayNumber" clearable controls-position="right" :min="1" :max="99999999" style="width:100%"></el-input-number>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="预警编号：" prop="warningNumber">
                  <el-input  v-model="querymodelForm.warningNumber" placeholder="内容长度不能超过50" maxlength="50"></el-input>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="主体名称：" prop="bodyName">
                  <el-input  v-model="querymodelForm.bodyName" placeholder="内容长度不能超过50" maxlength="50"></el-input>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="证件号码：" prop="idNumber">
                  <el-input  v-model="querymodelForm.idNumber" placeholder="内容长度不能超过50" maxlength="50"></el-input>
                </el-form-item>
              </el-col>
            </el-row>
            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="状态：" prop="status">
                  <el-select clearable v-model="querymodelForm.status" placeholder="请选择">
                    <el-option label="未分配" value="未分配"></el-option>
                    <el-option label="待处理" value="待处理"></el-option>
                    <el-option label="处理中" value="处理中"></el-option>
                    <el-option label="已处理" value="已处理"></el-option>
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="预警日期：" prop="warningDate">
                  <el-date-picker unlink-panels clearable  value-format="yyyy-MM-dd" v-model="querymodelForm.warningDate" type="daterange" range-separator="~" start-placeholder="开始日期" end-placeholder="结束日期"></el-date-picker>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <div style="text-align:right;margin-bottom:6px;">
                  <el-button type="primary" @click="handleSearch">查 询</el-button>
                  <el-button @click="handleClearForm" type="primary" plain>清 空</el-button>
                </div>
              </el-col>
            </el-row>
          </el-form>
          <el-table :data="tableData"
           tooltip-effect="dark"
           v-loading="loadingrankingRules"
            element-loading-text="首次加载较慢，请稍侯!"
            element-loading-spinner="el-icon-loading"
            element-loading-background="rgba(0, 0, 0, 0.1)"
           >
            <el-table-column label="序号" type="index" width="50" fixed="left"></el-table-column>
            <el-table-column label="预警编号" prop="warningNum" min-width="250" show-overflow-tooltip>
              <!-- <template slot-scope="scope">
                <el-popover trigger="hover" placement="top">
                    <p>{{scope.row.dmRankmSynchronizations.warningNum}}</p>
                    <div slot="reference" class="name-wrapper">
                        <el-tag size="medium" style="width: 100%;overflow: hidden;">
                            {{scope.row.dmRankmSynchronizations.warningNum}}
                        </el-tag>
                    </div>
                </el-popover>
              </template> -->
            </el-table-column>
            <el-table-column label="主体名称" prop="ctnm" min-width="200" show-overflow-tooltip></el-table-column>
            <el-table-column label="证件号码" prop="ctid" min-width="150" show-overflow-tooltip></el-table-column>
            <el-table-column label="预警日期" prop="datBegin" min-width="120" show-overflow-tooltip></el-table-column>
            <el-table-column label="状态" prop="status" min-width="100" show-overflow-tooltip></el-table-column>
            <el-table-column label="操作" fixed="right" width="170">
              <template slot-scope="scope">
                <el-button type="text" @click="handleGo(scope)">进入分析工具</el-button>
                <el-button type="text" :disabled="scope.row.status === '已处理'" @click="handleLook(scope)">创建线索表</el-button>
              </template>
            </el-table-column>
          </el-table>
          <el-pagination v-if="this.total" @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="pageNum" :page-sizes="[10, 20, 30, 40, 50]" :page-size="pageSize" layout="total, sizes, prev, pager, next, jumper" :total="total" background>
          </el-pagination>
        </el-col>
      </el-row>

    </el-card>

  </div>
</template>
<script>
import { noSpaceAndTs } from '@/utils/formValidate.js'
import {
  getTreeData,
  fuzzyListData
} from '@/api/sys-monitoringAnalysis/rankingRules/index.js'
import {
  creatXsTable
} from '@/api/sys-monitoringAnalysis/warningProcessing/view'
export default {
  name: 'rankingRules',
  data() {
    return {
      modelForm: {
        ruleName: '',
        rulesInterpretation: '',
        warningCycle: ''
      },
      loadingrankingRules: false,
      querymodelForm: {
        bodyName: '',
        displayNumber: 1000,
        idNumber: '',
        resultsDisplay: '',
        sortord: 'desc',
        status: '',
        warningDate: '',
        warningNumber: ''
      },
      tableData: [],
      total: null,
      pageSize: 10,
      pageNum: 1,
      rulesForm: {
        bodyName: [
          { validator: noSpaceAndTs, trigger: 'blur' },
          { max: 50, message: '最大长度不能超过50位', trigger: 'blur' }],
        idNumber: [
          { validator: noSpaceAndTs, trigger: 'blur' },
          { max: 50, message: '最大长度不能超过50位', trigger: 'blur' }],
        resultsDisplay: [
          { validator: noSpaceAndTs, trigger: 'change' }],
        warningNumber: [
          { validator: noSpaceAndTs, trigger: 'blur' },
          { max: 50, message: '最大长度不能超过50位', trigger: 'blur' }]
      },
      defaultProps: {
        children: 'ruleInterpretationTable',
        label: 'clientType'
      },
      tableDataTree: [],
      defaultSelectionTree: [],
      mouthInfo: '',
      userIdInfo: ''
      // defaultOPenTree: []
    }
  },
  computed: {
    params: function() {
      return {
        key: this.modelForm.ruleKey,
        ctnm: this.querymodelForm.bodyName ? this.querymodelForm.bodyName : '',
        displayNumber: this.querymodelForm.displayNumber,
        ctid: this.querymodelForm.idNumber ? this.querymodelForm.idNumber : '',
        resultsDisplay: this.querymodelForm.resultsDisplay ? this.querymodelForm.resultsDisplay : '',
        sortord: this.querymodelForm.sortord ? this.querymodelForm.sortord : '',
        status: this.querymodelForm.status ? this.querymodelForm.status : '',
        startTime: this.querymodelForm.warningDate ? this.querymodelForm.warningDate[0] : '',
        endTime: this.querymodelForm.warningDate ? this.querymodelForm.warningDate[1] : '',
        warningNum: this.querymodelForm.warningNumber ? this.querymodelForm.warningNumber : '',
        cclientType: this.modelForm.cclientType ? this.modelForm.cclientType : ''
      }
    }
  },
  mounted() {
    this.loadingrankingRules = true
    this.getTreeInfo()
  },
  methods: {
    // 获取左侧tree数据
    getTreeInfo() {
      this.defaultSelectionTree = []
      getTreeData().then(res => {
        if (res.code === 200) {
          const showData = res.data
          for (let i = 0; i < showData.length; i++) {
            if (showData[i].clientType === 'ORG') {
              showData[i].clientType = '机构'
            } else if (showData[i].clientType === 'PER') {
              showData[i].clientType = '个人'
            }
          }
          this.tableDataTree = showData
          this.mouthInfo = '月'
          this.defaultSelectionTree.push(this.tableDataTree[0].ruleInterpretationTable[0].ruleKey)
          this.modelForm = this.tableDataTree[0].ruleInterpretationTable[0]
          // this.pageSize = this.querymodelForm.displayNumber
          if (sessionStorage.getItem('searchDataPMYJGZ')) {
            const searchData = JSON.parse(sessionStorage.getItem('searchDataPMYJGZ'))
            if (searchData.pageName === this.$route.name && searchData.ifReviewPMYJGZSxp) {
              this.userIdInfo = searchData.dataUserid
              this.pageSize = searchData.pageInfo.pageSize
              this.pageNum = searchData.pageInfo.pageNum
              this.querymodelForm = searchData.searchForm
            } else {
              this.userIdInfo = this.tableDataTree[0].ruleInterpretationTable[0].userId
            }
            sessionStorage.removeItem('searchDataPMYJGZ')
          } else {
            this.userIdInfo = this.tableDataTree[0].ruleInterpretationTable[0].userId
          }
          this.fuzzyQuery(this.pageSize, this.pageNum, this.params, this.userIdInfo)
        } else {
          this.$message({
            type: 'error',
            message: '获取树形数据失败！',
            duration: 6000,
            showClose: true
          })
        }
      })
    },
    // tree 点击事件
    handleNodeClick(data) {
      if (data.rulesId) {
        this.defaultSelectionTree = []
        this.defaultSelectionTree.push(data.ruleKey)
        this.modelForm = data
        this.userIdInfo = data.userId
        this.loadingrankingRules = true
        this.fuzzyQuery(this.pageSize, this.pageNum, this.params, data.userId)
      }
    },
    // 右侧table列表查询展示
    fuzzyQuery(size, num, params, userId) {
      params.userId = userId
      fuzzyListData(size, num, params).then(res => {
        if (res.code === 200) {
          this.tableData = res.data.list
          this.total = res.data.total
          this.loadingrankingRules = false
        } else {
          this.loadingrankingRules = false
          this.$message({
            type: 'error',
            message: res.message,
            duration: 6000,
            showClose: true
          })
        }
      })
        .catch(() => {
          this.loadingrankingRules = false
        })
    },
    // 分页
    handleSizeChange(val) {
      this.pageSize = val
      this.loadingrankingRules = true
      this.fuzzyQuery(this.pageSize, this.pageNum, this.params, this.modelForm.userId)
    },
    handleCurrentChange(val) {
      this.pageNum = val
      this.loadingrankingRules = true
      this.fuzzyQuery(this.pageSize, this.pageNum, this.params, this.modelForm.userId)
    },

    // 查询
    handleSearch() {
      this.$refs.refForm.validate((valid) => {
        if (valid) {
          this.loadingrankingRules = true
          this.fuzzyQuery(10, 1, this.params, this.modelForm.userId)
        }
      })
    },

    // 清空
    handleClearForm() {
      this.$refs.refForm.resetFields()
      this.querymodelForm.displayNumber = 1000
    //   this.pageSize = 10
    //   this.pageNum = 1
    //   this.fuzzyQuery(10, 1, this.params, this.modelForm.userId)
    },

    // 进入分析工具
    handleGo(scope) {
      window.open('http://' + window.inAnalysisTools + '/datac/jsp/security/askLogin', '_blank')
    },

    // 创建线索表
    handleLook(scope) {
      const pageInfo = {
        pageSize: this.pageSize,
        pageNum: this.pageNum
      }
      const searchDataPMYJGZ = {
        pageName: this.$route.name,
        dataUserid: this.userIdInfo,
        pageInfo: pageInfo,
        searchForm: this.querymodelForm
      }
      sessionStorage.setItem('searchDataPMYJGZ', JSON.stringify(searchDataPMYJGZ))
      creatXsTable(scope.row.warningNum).then(res => {
        if (res.code === 200) {
          if (res.data === 'false') {
            this.$router.push({
              name: 'cueManage_autonomousAnalysisInfo',
              query: {
                activeName: 'second',
                keyIndex: '2',
                triggerForm: '规则预警',
                index: scope.row.warningNum
              }
            })
          } else {
            this.$message({
              message: res.message,
              type: 'warning',
              duration: 6000,
              showClose: true
            })
          }
        } else {
          this.$message({
            message: res.message,
            type: 'error',
            duration: 6000
          })
        }
      })
    }
  }
}
</script>
<style lang="scss" scoped>
.rankingRules {
  .el-date-editor--daterange {
    width: 100% !important;
  }
  .el-date-editor {
    width: 100%;
  }
  .el-select {
    width: 100%;
  }
  .treeClassName {
    .span-ellipsis {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .el-tree-node{
      .el-tree-node__children{
        .el-tree-node{
          .el-tree-node__content{
            .el-tree-node__label{
                  width: 220px;
                  overflow: hidden;
                  color: #606266;
                  text-overflow: ellipsis;
                  white-space: nowrap;
            }
          }
        }

      }
    }
  }
}
</style>

